<!DOCTYPE html>

<html layout:decorator="main/layout">
  <head>
    <title>Avatar - WebChat</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
 

  </head>
  <body>

    <div class="col s9 grey lighten-4" layout:fragment="content" >
        
        <h4>Chat test</h4>
        
            <div id="conversationDiv">
                <input type="text" id="inputText" placeholder="Write a message..."/>
                <button id="sendMessage" >Send</button>
              
            </div>
            
            <ul id="myList">
            
           
            </ul>
            
    </div>
        
    <th:block layout:fragment="script">
       
    <script type="text/javascript">
             
            var ws;
            var stompClient;
            
            
            $(document).ready(function(){
                document.querySelector('#sendMessage').addEventListener('click', send);
                ws = new SockJS("/WebChat/chat");
                stompClient = Stomp.over(ws);

                stompClient.connect({}, function(frame){

                    stompClient.subscribe("/topic/messages", function(message){
                        var content = JSON.parse(message.body);
                        var node = document.createElement("LI");
                        var textnode = document.createTextNode(content.from + " says " + content.text + "|" + content.time);
                        node.appendChild(textnode);
                        document.getElementById("myList").appendChild(node);
                    });
                });
            });
            function send(){
                var message = document.getElementById("inputText").value;
                var user = "[[${session.user.username}]]";
                stompClient.send("/app/chat",{}, JSON.stringify({'from':user, 'text':message} ));
            }
            
    </script>
     <script src="../../scripts/sockjs-0.3.4.js" th:src="@{/scripts/sockjs-0.3.4.js}"></script>
        <script src="../../scripts/stomp.js" th:src="@{/scripts/stomp.js}"></script>
  </th:block>
  </body>
</html>
